steps:
- id: 'tf init'
  name: 'hashicorp/terraform:1.0.0'
  entrypoint: 'sh'
  args: 
  - '-c'
  - | 
    terraform init
  dir: infra   
  
- id: 'tf apply'
  name: 'hashicorp/terraform:1.0.0'
  entrypoint: 'sh'
  args: 
  - '-c'
  - |
    terraform apply --auto-approve
    export APP_SERVER_PRIVATE_IP1=$(terraform output -raw app_server_private
    echo $APP_SERVER_PRIVATE_IP
  dir: infra

- id: 'replace ip in nginx.conf'
  name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo $APP_SERVER_PRIVATE_IP
      echo "BEFORE REPLACEMENT"
      vim nginx.conf
      sudo sed -i "s/APP_SERVER_PRIVATE_IP/$APP_SERVER_PRIVATE_IP/g" nginx.conf
      echo "AFTER REPLACEMENT"
      vim nginx.conf
  dir: application-code


- id: 'build backend'
  name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    gcloud auth configure-docker europe-west1-docker.pkg.dev
    docker build --tag europe-west1-docker.pkg.dev/dynamic-parity-426014-s3/akscicdprivate/backend .
    docker push europe-west1-docker.pkg.dev/dynamic-parity-426014-s3/akscicdprivate/backend
  dir: backend-docker-image

- id: 'build frontend'
  name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    gcloud auth configure-docker europe-west1-docker.pkg.dev
    docker build --tag europe-west1-docker.pkg.dev/dynamic-parity-426014-s3/akscicdprivate/frontend .
    docker push europe-west1-docker.pkg.dev/dynamic-parity-426014-s3/akscicdprivate/frontend
  dir: frontend-docker-image


options:
  env:
    - TF_VAR_project_id=$PROJECT_ID
  logging: CLOUD_LOGGING_ONLY


timeout: 3600s
